name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-deploy: # Renamed job for clarity
    name: Build and Deploy to WordPress.org
    runs-on: ubuntu-latest
    permissions:
      contents: write # For softprops/action-gh-release

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Ensure tag commit is on main
        run: |
          git fetch --no-tags origin main
          if ! git merge-base --is-ancestor "$GITHUB_SHA" origin/main; then
            echo "Tag commit is not contained in main. Aborting release." >&2
            exit 1
          fi

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1' # Adjust to project's required PHP version
          tools: composer:v2
          coverage: none
          ini-values: memory_limit=-1

      - name: Validate composer.json
        run: composer validate --strict

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Run PHPCS
        run: |
          if composer run -q phpcs 2>/dev/null; then
            composer phpcs
          else
            echo "No phpcs script; skipping."
          fi
      
      # Node.js setup and asset building
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' # Use a stable Node.js version appropriate for your project

      - name: Install Node.js dependencies
        run: npm install --prefix . # Install npm dependencies in the current directory

      - name: Build project assets
        run: php vendor/bin/moo build --no-interaction

      - name: Deploy to WordPress.org
        uses: 10up/action-wordpress-plugin-deploy@stable
        with:
          generate-zip: true # Generate a ZIP file from the deployed plugin
        env:
          SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.GITHUB_TOKEN }} # Use GITHUB_TOKEN for password if using deploy tokens
                                                    # Otherwise, use secrets.SVN_PASSWORD for standard SVN password.

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ github.workspace }}/${{ github.event.repository.name }}.zip # Upload the generated ZIP
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Provided by GitHub Actions for authenticating with GitHub